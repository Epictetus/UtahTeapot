unit Core;

interface //#################################################################### ■

uses System.Types, System.Classes, System.Math.Vectors,
     FMX.Types3D, FMX.Controls3D, FMX.MaterialSources,
     LUX, LUX.D1, LUX.D2, LUX.D3, LUX.D3.M4, LUX.M4;

type //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【型】

     //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【レコード】

     //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【クラス】

     //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% TTeapotShape

     TTeapotShape = class( TControl3D )
     private
       ///// メソッド
       procedure MakeModel;
     protected
       _Geometry :TMeshData;
       _Material :TMaterialSource;
       _DivN     :Integer;
       ///// アクセス
       procedure SetDivN( const DivN_:Integer );
       ///// メソッド
       procedure Render; override;
     public
       constructor Create( Owner_:TComponent ); override;
       destructor Destroy; override;
       ///// プロパティ
       property Geometry :TMeshData       read _Geometry                  ;
       property Material :TMaterialSource read _Material write   _Material;
       property DivN     :Integer         read _DivN     write SetDivN    ;
     end;

const //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【定数】

      TeapotPatcs :array [ 1..32 ] of TIntegerM4 =
           ( ///// Lid
             ( _:( (   0,   0,   0,   0 ), (   1,   2,   3,   4 ), (   5,   5,   5,   5 ), (   6,   7,   8,   9 ) ) ),
             ( _:( (   0,   0,   0,   0 ), (  10,  11,  12,   1 ), (   5,   5,   5,   5 ), (  13,  14,  15,   6 ) ) ),
             ( _:( (   0,   0,   0,   0 ), (   4,  16,  17,  18 ), (   5,   5,   5,   5 ), (   9,  19,  20,  21 ) ) ),
             ( _:( (   0,   0,   0,   0 ), (  18,  22,  23,  10 ), (   5,   5,   5,   5 ), (  21,  24,  25,  13 ) ) ),
             ( _:( (   6,   7,   8,   9 ), (  26,  27,  28,  29 ), (  30,  31,  32,  33 ), (  34,  35,  36,  37 ) ) ),
             ( _:( (  13,  14,  15,   6 ), (  38,  39,  40,  26 ), (  41,  42,  43,  30 ), (  44,  45,  46,  34 ) ) ),
             ( _:( (   9,  19,  20,  21 ), (  29,  47,  48,  49 ), (  33,  50,  51,  52 ), (  37,  53,  54,  55 ) ) ),
             ( _:( (  21,  24,  25,  13 ), (  49,  56,  57,  38 ), (  52,  58,  59,  41 ), (  55,  60,  61,  44 ) ) ),
             ///// Rim
             ( _:( (  62,  63,  64,  65 ), (  66,  67,  68,  69 ), (  70,  71,  72,  73 ), (  74,  75,  76,  77 ) ) ),
             ( _:( (  78,  79,  80,  62 ), (  81,  82,  83,  66 ), (  84,  85,  86,  70 ), (  87,  88,  89,  74 ) ) ),
             ( _:( (  65,  90,  91,  92 ), (  69,  93,  94,  95 ), (  73,  96,  97,  98 ), (  77,  99, 100, 101 ) ) ),
             ( _:( (  92, 102, 103,  78 ), (  95, 104, 105,  81 ), (  98, 106, 107,  84 ), ( 101, 108, 109,  87 ) ) ),
             //// Body
             ( _:( (  74,  75,  76,  77 ), ( 110, 111, 112, 113 ), ( 114, 115, 116, 117 ), ( 118, 119, 120, 121 ) ) ),
             ( _:( (  87,  88,  89,  74 ), ( 122, 123, 124, 110 ), ( 125, 126, 127, 114 ), ( 128, 129, 130, 118 ) ) ),
             ( _:( (  77,  99, 100, 101 ), ( 113, 131, 132, 133 ), ( 117, 134, 135, 136 ), ( 121, 137, 138, 139 ) ) ),
             ( _:( ( 101, 108, 109,  87 ), ( 133, 140, 141, 122 ), ( 136, 142, 143, 125 ), ( 139, 144, 145, 128 ) ) ),
             ( _:( ( 118, 119, 120, 121 ), ( 146, 147, 148, 149 ), ( 150, 151, 152, 153 ), ( 154, 155, 156, 157 ) ) ),
             ( _:( ( 128, 129, 130, 118 ), ( 158, 159, 160, 146 ), ( 161, 162, 163, 150 ), ( 164, 165, 166, 154 ) ) ),
             ( _:( ( 121, 137, 138, 139 ), ( 149, 167, 168, 169 ), ( 153, 170, 171, 172 ), ( 157, 173, 174, 175 ) ) ),
             ( _:( ( 139, 144, 145, 128 ), ( 169, 176, 177, 158 ), ( 172, 178, 179, 161 ), ( 175, 180, 181, 164 ) ) ),
             ///// Bottom
             ( _:( ( 154, 155, 156, 157 ), ( 182, 183, 184, 185 ), ( 186, 187, 188, 189 ), ( 190, 190, 190, 190 ) ) ),
             ( _:( ( 164, 165, 166, 154 ), ( 191, 192, 193, 182 ), ( 194, 195, 196, 186 ), ( 190, 190, 190, 190 ) ) ),
             ( _:( ( 157, 173, 174, 175 ), ( 185, 197, 198, 199 ), ( 189, 200, 201, 202 ), ( 190, 190, 190, 190 ) ) ),
             ( _:( ( 175, 180, 181, 164 ), ( 199, 203, 204, 191 ), ( 202, 205, 206, 194 ), ( 190, 190, 190, 190 ) ) ),
             ///// Spout
             ( _:( ( 207, 208, 209, 210 ), ( 211, 212, 213, 214 ), ( 215, 216, 217, 218 ), ( 219, 220, 221, 222 ) ) ),
             ( _:( ( 210, 223, 224, 207 ), ( 214, 225, 226, 211 ), ( 218, 227, 228, 215 ), ( 222, 229, 230, 219 ) ) ),
             ( _:( ( 219, 220, 221, 222 ), ( 231, 232, 233, 234 ), ( 235, 236, 237, 238 ), ( 239, 240, 241, 242 ) ) ),
             ( _:( ( 222, 229, 230, 219 ), ( 234, 243, 244, 231 ), ( 238, 245, 246, 235 ), ( 242, 247, 248, 239 ) ) ),
             ///// Handle
             ( _:( ( 249, 250, 251, 252 ), ( 253, 254, 255, 256 ), ( 257, 258, 259, 260 ), ( 261, 262, 263, 264 ) ) ),
             ( _:( ( 252, 265, 266, 249 ), ( 256, 267, 268, 253 ), ( 260, 269, 270, 257 ), ( 264, 271, 272, 261 ) ) ),
             ( _:( ( 261, 262, 263, 264 ), ( 273, 274, 275, 276 ), ( 277, 278, 279, 280 ), ( 281, 282, 283, 128 ) ) ),
             ( _:( ( 264, 271, 272, 261 ), ( 276, 284, 285, 273 ), ( 280, 286, 287, 277 ), ( 128, 288, 289, 281 ) ) ) );

      TeapotVerts :array [ 0..290-1 ] of TSingle3D =
           ( ( X: 0      ; Y: 0      ; Z:+3.15    ), ( X: 0      ; Y:-0.8    ; Z:+3.15    ),
             ( X:+0.45   ; Y:-0.8    ; Z:+3.15    ), ( X:+0.8    ; Y:-0.45   ; Z:+3.15    ),
             ( X:+0.8    ; Y: 0      ; Z:+3.15    ), ( X: 0      ; Y: 0      ; Z:+2.85    ),
             ( X: 0      ; Y:-0.2    ; Z:+2.7     ), ( X:+0.112  ; Y:-0.2    ; Z:+2.7     ),
             ( X:+0.2    ; Y:-0.112  ; Z:+2.7     ), ( X:+0.2    ; Y: 0      ; Z:+2.7     ),
             ( X:-0.8    ; Y: 0      ; Z:+3.15    ), ( X:-0.8    ; Y:-0.45   ; Z:+3.15    ),
             ( X:-0.45   ; Y:-0.8    ; Z:+3.15    ), ( X:-0.2    ; Y: 0      ; Z:+2.7     ),
             ( X:-0.2    ; Y:-0.112  ; Z:+2.7     ), ( X:-0.112  ; Y:-0.2    ; Z:+2.7     ),
             ( X:+0.8    ; Y:+0.45   ; Z:+3.15    ), ( X:+0.45   ; Y:+0.8    ; Z:+3.15    ),
             ( X: 0      ; Y:+0.8    ; Z:+3.15    ), ( X:+0.2    ; Y:+0.112  ; Z:+2.7     ),
             ( X:+0.112  ; Y:+0.2    ; Z:+2.7     ), ( X: 0      ; Y:+0.2    ; Z:+2.7     ),
             ( X:-0.45   ; Y:+0.8    ; Z:+3.15    ), ( X:-0.8    ; Y:+0.45   ; Z:+3.15    ),
             ( X:-0.112  ; Y:+0.2    ; Z:+2.7     ), ( X:-0.2    ; Y:+0.112  ; Z:+2.7     ),
             ( X: 0      ; Y:-0.4    ; Z:+2.55    ), ( X:+0.224  ; Y:-0.4    ; Z:+2.55    ),
             ( X:+0.4    ; Y:-0.224  ; Z:+2.55    ), ( X:+0.4    ; Y: 0      ; Z:+2.55    ),
             ( X: 0      ; Y:-1.3    ; Z:+2.55    ), ( X:+0.728  ; Y:-1.3    ; Z:+2.55    ),
             ( X:+1.3    ; Y:-0.728  ; Z:+2.55    ), ( X:+1.3    ; Y: 0      ; Z:+2.55    ),
             ( X: 0      ; Y:-1.3    ; Z:+2.4     ), ( X:+0.728  ; Y:-1.3    ; Z:+2.4     ),
             ( X:+1.3    ; Y:-0.728  ; Z:+2.4     ), ( X:+1.3    ; Y: 0      ; Z:+2.4     ),
             ( X:-0.4    ; Y: 0      ; Z:+2.55    ), ( X:-0.4    ; Y:-0.224  ; Z:+2.55    ),
             ( X:-0.224  ; Y:-0.4    ; Z:+2.55    ), ( X:-1.3    ; Y: 0      ; Z:+2.55    ),
             ( X:-1.3    ; Y:-0.728  ; Z:+2.55    ), ( X:-0.728  ; Y:-1.3    ; Z:+2.55    ),
             ( X:-1.3    ; Y: 0      ; Z:+2.4     ), ( X:-1.3    ; Y:-0.728  ; Z:+2.4     ),
             ( X:-0.728  ; Y:-1.3    ; Z:+2.4     ), ( X:+0.4    ; Y:+0.224  ; Z:+2.55    ),
             ( X:+0.224  ; Y:+0.4    ; Z:+2.55    ), ( X: 0      ; Y:+0.4    ; Z:+2.55    ),
             ( X:+1.3    ; Y:+0.728  ; Z:+2.55    ), ( X:+0.728  ; Y:+1.3    ; Z:+2.55    ),
             ( X: 0      ; Y:+1.3    ; Z:+2.55    ), ( X:+1.3    ; Y:+0.728  ; Z:+2.4     ),
             ( X:+0.728  ; Y:+1.3    ; Z:+2.4     ), ( X: 0      ; Y:+1.3    ; Z:+2.4     ),
             ( X:-0.224  ; Y:+0.4    ; Z:+2.55    ), ( X:-0.4    ; Y:+0.224  ; Z:+2.55    ),
             ( X:-0.728  ; Y:+1.3    ; Z:+2.55    ), ( X:-1.3    ; Y:+0.728  ; Z:+2.55    ),
             ( X:-0.728  ; Y:+1.3    ; Z:+2.4     ), ( X:-1.3    ; Y:+0.728  ; Z:+2.4     ),
             ( X: 0      ; Y:-1.4    ; Z:+2.4     ), ( X:+0.784  ; Y:-1.4    ; Z:+2.4     ),
             ( X:+1.4    ; Y:-0.784  ; Z:+2.4     ), ( X:+1.4    ; Y: 0      ; Z:+2.4     ),
             ( X: 0      ; Y:-1.3375 ; Z:+2.53125 ), ( X:+0.749  ; Y:-1.3375 ; Z:+2.53125 ),
             ( X:+1.3375 ; Y:-0.749  ; Z:+2.53125 ), ( X:+1.3375 ; Y: 0      ; Z:+2.53125 ),
             ( X: 0      ; Y:-1.4375 ; Z:+2.53125 ), ( X:+0.805  ; Y:-1.4375 ; Z:+2.53125 ),
             ( X:+1.4375 ; Y:-0.805  ; Z:+2.53125 ), ( X:+1.4375 ; Y: 0      ; Z:+2.53125 ),
             ( X: 0      ; Y:-1.5    ; Z:+2.4     ), ( X:+0.84   ; Y:-1.5    ; Z:+2.4     ),
             ( X:+1.5    ; Y:-0.84   ; Z:+2.4     ), ( X:+1.5    ; Y: 0      ; Z:+2.4     ),
             ( X:-1.4    ; Y: 0      ; Z:+2.4     ), ( X:-1.4    ; Y:-0.784  ; Z:+2.4     ),
             ( X:-0.784  ; Y:-1.4    ; Z:+2.4     ), ( X:-1.3375 ; Y: 0      ; Z:+2.53125 ),
             ( X:-1.3375 ; Y:-0.749  ; Z:+2.53125 ), ( X:-0.749  ; Y:-1.3375 ; Z:+2.53125 ),
             ( X:-1.4375 ; Y: 0      ; Z:+2.53125 ), ( X:-1.4375 ; Y:-0.805  ; Z:+2.53125 ),
             ( X:-0.805  ; Y:-1.4375 ; Z:+2.53125 ), ( X:-1.5    ; Y: 0      ; Z:+2.4     ),
             ( X:-1.5    ; Y:-0.84   ; Z:+2.4     ), ( X:-0.84   ; Y:-1.5    ; Z:+2.4     ),
             ( X:+1.4    ; Y:+0.784  ; Z:+2.4     ), ( X:+0.784  ; Y:+1.4    ; Z:+2.4     ),
             ( X: 0      ; Y:+1.4    ; Z:+2.4     ), ( X:+1.3375 ; Y:+0.749  ; Z:+2.53125 ),
             ( X:+0.749  ; Y:+1.3375 ; Z:+2.53125 ), ( X: 0      ; Y:+1.3375 ; Z:+2.53125 ),
             ( X:+1.4375 ; Y:+0.805  ; Z:+2.53125 ), ( X:+0.805  ; Y:+1.4375 ; Z:+2.53125 ),
             ( X: 0      ; Y:+1.4375 ; Z:+2.53125 ), ( X:+1.5    ; Y:+0.84   ; Z:+2.4     ),
             ( X:+0.84   ; Y:+1.5    ; Z:+2.4     ), ( X: 0      ; Y:+1.5    ; Z:+2.4     ),
             ( X:-0.784  ; Y:+1.4    ; Z:+2.4     ), ( X:-1.4    ; Y:+0.784  ; Z:+2.4     ),
             ( X:-0.749  ; Y:+1.3375 ; Z:+2.53125 ), ( X:-1.3375 ; Y:+0.749  ; Z:+2.53125 ),
             ( X:-0.805  ; Y:+1.4375 ; Z:+2.53125 ), ( X:-1.4375 ; Y:+0.805  ; Z:+2.53125 ),
             ( X:-0.84   ; Y:+1.5    ; Z:+2.4     ), ( X:-1.5    ; Y:+0.84   ; Z:+2.4     ),
             ( X: 0      ; Y:-1.75   ; Z:+1.875   ), ( X:+0.98   ; Y:-1.75   ; Z:+1.875   ),
             ( X:+1.75   ; Y:-0.98   ; Z:+1.875   ), ( X:+1.75   ; Y: 0      ; Z:+1.875   ),
             ( X: 0      ; Y:-2      ; Z:+1.35    ), ( X:+1.12   ; Y:-2      ; Z:+1.35    ),
             ( X:+2      ; Y:-1.12   ; Z:+1.35    ), ( X:+2      ; Y: 0      ; Z:+1.35    ),
             ( X: 0      ; Y:-2      ; Z:+0.9     ), ( X:+1.12   ; Y:-2      ; Z:+0.9     ),
             ( X:+2      ; Y:-1.12   ; Z:+0.9     ), ( X:+2      ; Y: 0      ; Z:+0.9     ),
             ( X:-1.75   ; Y: 0      ; Z:+1.875   ), ( X:-1.75   ; Y:-0.98   ; Z:+1.875   ),
             ( X:-0.98   ; Y:-1.75   ; Z:+1.875   ), ( X:-2      ; Y: 0      ; Z:+1.35    ),
             ( X:-2      ; Y:-1.12   ; Z:+1.35    ), ( X:-1.12   ; Y:-2      ; Z:+1.35    ),
             ( X:-2      ; Y: 0      ; Z:+0.9     ), ( X:-2      ; Y:-1.12   ; Z:+0.9     ),
             ( X:-1.12   ; Y:-2      ; Z:+0.9     ), ( X:+1.75   ; Y:+0.98   ; Z:+1.875   ),
             ( X:+0.98   ; Y:+1.75   ; Z:+1.875   ), ( X: 0      ; Y:+1.75   ; Z:+1.875   ),
             ( X:+2      ; Y:+1.12   ; Z:+1.35    ), ( X:+1.12   ; Y:+2      ; Z:+1.35    ),
             ( X: 0      ; Y:+2      ; Z:+1.35    ), ( X:+2      ; Y:+1.12   ; Z:+0.9     ),
             ( X:+1.12   ; Y:+2      ; Z:+0.9     ), ( X: 0      ; Y:+2      ; Z:+0.9     ),
             ( X:-0.98   ; Y:+1.75   ; Z:+1.875   ), ( X:-1.75   ; Y:+0.98   ; Z:+1.875   ),
             ( X:-1.12   ; Y:+2      ; Z:+1.35    ), ( X:-2      ; Y:+1.12   ; Z:+1.35    ),
             ( X:-1.12   ; Y:+2      ; Z:+0.9     ), ( X:-2      ; Y:+1.12   ; Z:+0.9     ),
             ( X: 0      ; Y:-2      ; Z:+0.45    ), ( X:+1.12   ; Y:-2      ; Z:+0.45    ),
             ( X:+2      ; Y:-1.12   ; Z:+0.45    ), ( X:+2      ; Y: 0      ; Z:+0.45    ),
             ( X: 0      ; Y:-1.5    ; Z:+0.225   ), ( X:+0.84   ; Y:-1.5    ; Z:+0.225   ),
             ( X:+1.5    ; Y:-0.84   ; Z:+0.225   ), ( X:+1.5    ; Y: 0      ; Z:+0.225   ),
             ( X: 0      ; Y:-1.5    ; Z:+0.15    ), ( X:+0.84   ; Y:-1.5    ; Z:+0.15    ),
             ( X:+1.5    ; Y:-0.84   ; Z:+0.15    ), ( X:+1.5    ; Y: 0      ; Z:+0.15    ),
             ( X:-2      ; Y: 0      ; Z:+0.45    ), ( X:-2      ; Y:-1.12   ; Z:+0.45    ),
             ( X:-1.12   ; Y:-2      ; Z:+0.45    ), ( X:-1.5    ; Y: 0      ; Z:+0.225   ),
             ( X:-1.5    ; Y:-0.84   ; Z:+0.225   ), ( X:-0.84   ; Y:-1.5    ; Z:+0.225   ),
             ( X:-1.5    ; Y: 0      ; Z:+0.15    ), ( X:-1.5    ; Y:-0.84   ; Z:+0.15    ),
             ( X:-0.84   ; Y:-1.5    ; Z:+0.15    ), ( X:+2      ; Y:+1.12   ; Z:+0.45    ),
             ( X:+1.12   ; Y:+2      ; Z:+0.45    ), ( X: 0      ; Y:+2      ; Z:+0.45    ),
             ( X:+1.5    ; Y:+0.84   ; Z:+0.225   ), ( X:+0.84   ; Y:+1.5    ; Z:+0.225   ),
             ( X: 0      ; Y:+1.5    ; Z:+0.225   ), ( X:+1.5    ; Y:+0.84   ; Z:+0.15    ),
             ( X:+0.84   ; Y:+1.5    ; Z:+0.15    ), ( X: 0      ; Y:+1.5    ; Z:+0.15    ),
             ( X:-1.12   ; Y:+2      ; Z:+0.45    ), ( X:-2      ; Y:+1.12   ; Z:+0.45    ),
             ( X:-0.84   ; Y:+1.5    ; Z:+0.225   ), ( X:-1.5    ; Y:+0.84   ; Z:+0.225   ),
             ( X:-0.84   ; Y:+1.5    ; Z:+0.15    ), ( X:-1.5    ; Y:+0.84   ; Z:+0.15    ),
             ( X: 0      ; Y:-1.5    ; Z:+0.075   ), ( X:+0.84   ; Y:-1.5    ; Z:+0.075   ),
             ( X:+1.5    ; Y:-0.84   ; Z:+0.075   ), ( X:+1.5    ; Y: 0      ; Z:+0.075   ),
             ( X: 0      ; Y:-1.425  ; Z:+0       ), ( X:+0.798  ; Y:-1.425  ; Z:+0       ),
             ( X:+1.425  ; Y:-0.798  ; Z:+0       ), ( X:+1.425  ; Y: 0      ; Z:+0       ),
             ( X: 0      ; Y: 0      ; Z:+0       ), ( X:-1.5    ; Y: 0      ; Z:+0.075   ),
             ( X:-1.5    ; Y:-0.84   ; Z:+0.075   ), ( X:-0.84   ; Y:-1.5    ; Z:+0.075   ),
             ( X:-1.425  ; Y: 0      ; Z:+0       ), ( X:-1.425  ; Y:-0.798  ; Z:+0       ),
             ( X:-0.798  ; Y:-1.425  ; Z:+0       ), ( X:+1.5    ; Y:+0.84   ; Z:+0.075   ),
             ( X:+0.84   ; Y:+1.5    ; Z:+0.075   ), ( X: 0      ; Y:+1.5    ; Z:+0.075   ),
             ( X:+1.425  ; Y:+0.798  ; Z:+0       ), ( X:+0.798  ; Y:+1.425  ; Z:+0       ),
             ( X: 0      ; Y:+1.425  ; Z:+0       ), ( X:-0.84   ; Y:+1.5    ; Z:+0.075   ),
             ( X:-1.5    ; Y:+0.84   ; Z:+0.075   ), ( X:-0.798  ; Y:+1.425  ; Z:+0       ),
             ( X:-1.425  ; Y:+0.798  ; Z:+0       ), ( X:+2.8    ; Y: 0      ; Z:+2.4     ),
             ( X:+2.8    ; Y:-0.15   ; Z:+2.4     ), ( X:+3.2    ; Y:-0.15   ; Z:+2.4     ),
             ( X:+3.2    ; Y: 0      ; Z:+2.4     ), ( X:+2.9    ; Y: 0      ; Z:+2.475   ),
             ( X:+2.9    ; Y:-0.15   ; Z:+2.475   ), ( X:+3.45   ; Y:-0.15   ; Z:+2.5125  ),
             ( X:+3.45   ; Y: 0      ; Z:+2.5125  ), ( X:+2.8    ; Y: 0      ; Z:+2.475   ),
             ( X:+2.8    ; Y:-0.25   ; Z:+2.475   ), ( X:+3.525  ; Y:-0.25   ; Z:+2.49375 ),
             ( X:+3.525  ; Y: 0      ; Z:+2.49375 ), ( X:+2.7    ; Y: 0      ; Z:+2.4     ),
             ( X:+2.7    ; Y:-0.25   ; Z:+2.4     ), ( X:+3.3    ; Y:-0.25   ; Z:+2.4     ),
             ( X:+3.3    ; Y: 0      ; Z:+2.4     ), ( X:+3.2    ; Y:+0.15   ; Z:+2.4     ),
             ( X:+2.8    ; Y:+0.15   ; Z:+2.4     ), ( X:+3.45   ; Y:+0.15   ; Z:+2.5125  ),
             ( X:+2.9    ; Y:+0.15   ; Z:+2.475   ), ( X:+3.525  ; Y:+0.25   ; Z:+2.49375 ),
             ( X:+2.8    ; Y:+0.25   ; Z:+2.475   ), ( X:+3.3    ; Y:+0.25   ; Z:+2.4     ),
             ( X:+2.7    ; Y:+0.25   ; Z:+2.4     ), ( X:+2.3    ; Y: 0      ; Z:+2.1     ),
             ( X:+2.3    ; Y:-0.25   ; Z:+2.1     ), ( X:+2.4    ; Y:-0.25   ; Z:+2.025   ),
             ( X:+2.4    ; Y: 0      ; Z:+2.025   ), ( X:+2.6    ; Y: 0      ; Z:+1.425   ),
             ( X:+2.6    ; Y:-0.66   ; Z:+1.425   ), ( X:+3.1    ; Y:-0.66   ; Z:+0.825   ),
             ( X:+3.1    ; Y: 0      ; Z:+0.825   ), ( X:+1.7    ; Y: 0      ; Z:+1.425   ),
             ( X:+1.7    ; Y:-0.66   ; Z:+1.425   ), ( X:+1.7    ; Y:-0.66   ; Z:+0.6     ),
             ( X:+1.7    ; Y: 0      ; Z:+0.6     ), ( X:+2.4    ; Y:+0.25   ; Z:+2.025   ),
             ( X:+2.3    ; Y:+0.25   ; Z:+2.1     ), ( X:+3.1    ; Y:+0.66   ; Z:+0.825   ),
             ( X:+2.6    ; Y:+0.66   ; Z:+1.425   ), ( X:+1.7    ; Y:+0.66   ; Z:+0.6     ),
             ( X:+1.7    ; Y:+0.66   ; Z:+1.425   ), ( X:-1.5    ; Y: 0      ; Z:+2.25    ),
             ( X:-1.5    ; Y:-0.3    ; Z:+2.25    ), ( X:-1.6    ; Y:-0.3    ; Z:+2.025   ),
             ( X:-1.6    ; Y: 0      ; Z:+2.025   ), ( X:-2.5    ; Y: 0      ; Z:+2.25    ),
             ( X:-2.5    ; Y:-0.3    ; Z:+2.25    ), ( X:-2.3    ; Y:-0.3    ; Z:+2.025   ),
             ( X:-2.3    ; Y: 0      ; Z:+2.025   ), ( X:-3      ; Y: 0      ; Z:+2.25    ),
             ( X:-3      ; Y:-0.3    ; Z:+2.25    ), ( X:-2.7    ; Y:-0.3    ; Z:+2.025   ),
             ( X:-2.7    ; Y: 0      ; Z:+2.025   ), ( X:-3      ; Y: 0      ; Z:+1.8     ),
             ( X:-3      ; Y:-0.3    ; Z:+1.8     ), ( X:-2.7    ; Y:-0.3    ; Z:+1.8     ),
             ( X:-2.7    ; Y: 0      ; Z:+1.8     ), ( X:-1.6    ; Y:+0.3    ; Z:+2.025   ),
             ( X:-1.5    ; Y:+0.3    ; Z:+2.25    ), ( X:-2.3    ; Y:+0.3    ; Z:+2.025   ),
             ( X:-2.5    ; Y:+0.3    ; Z:+2.25    ), ( X:-2.7    ; Y:+0.3    ; Z:+2.025   ),
             ( X:-3      ; Y:+0.3    ; Z:+2.25    ), ( X:-2.7    ; Y:+0.3    ; Z:+1.8     ),
             ( X:-3      ; Y:+0.3    ; Z:+1.8     ), ( X:-3      ; Y: 0      ; Z:+1.35    ),
             ( X:-3      ; Y:-0.3    ; Z:+1.35    ), ( X:-2.7    ; Y:-0.3    ; Z:+1.575   ),
             ( X:-2.7    ; Y: 0      ; Z:+1.575   ), ( X:-2.65   ; Y: 0      ; Z:+0.9375  ),
             ( X:-2.65   ; Y:-0.3    ; Z:+0.9375  ), ( X:-2.5    ; Y:-0.3    ; Z:+1.125   ),
             ( X:-2.5    ; Y: 0      ; Z:+1.125   ), ( X:-1.9    ; Y: 0      ; Z:+0.6     ),
             ( X:-1.9    ; Y:-0.3    ; Z:+0.6     ), ( X:-2      ; Y:-0.3    ; Z:+0.9     ),
             ( X:-2.7    ; Y:+0.3    ; Z:+1.575   ), ( X:-3      ; Y:+0.3    ; Z:+1.35    ),
             ( X:-2.5    ; Y:+0.3    ; Z:+1.125   ), ( X:-2.65   ; Y:+0.3    ; Z:+0.9375  ),
             ( X:-2      ; Y:+0.3    ; Z:+0.9     ), ( X:-1.9    ; Y:+0.3    ; Z:+0.6     ) );

//var //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【変数】

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【ルーチン】

implementation //############################################################### ■

uses System.SysUtils, System.RTLConsts,
     LUX.Curve.T2.D3;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【レコード】

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【クラス】

//%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% TTeapotShape

//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& private

procedure TTeapotShape.MakeModel;
var
   N1, I0 :Integer;
//･･････････････････････････････
     function XYtoI( const X_,Y_:Integer ) :Integer;
     begin
          Result := I0 + N1 * Y_ + X_;
     end;
//･･････････････････････････････
var
   PatcsN, N2, I, J, X, Y, X0, Y0, X1, Y1 :Integer;
   Ps :TSingle3DM4;
   T :TSingle2D;
   M :TSingleM4;
begin
     PatcsN := Length( TeapotPatcs );

     N1 := _DivN + 1;  N2 := Pow2( N1 );

     with _Geometry do
     begin
          with VertexBuffer do
          begin
               Length := PatcsN{Patc} * N2{Poin};

               J := 0;
               for I := 1 to PatcsN do
               begin
                    for Y := 1 to 4 do
                    for X := 1 to 4 do Ps[ Y, X ] := TeapotVerts[ TeapotPatcs[ I ][ Y, X ] ];

                    for Y := 0 to _DivN do
                    begin
                         T.Y := Y / _DivN;

                         for X := 0 to _DivN do
                         begin
                              T.X := X / _DivN;

                              M := TensorBezie4( Ps, T );

                              Vertices [ J ] := M.AxisP;
                              Tangents [ J ] := M.AxisX;
                              BiNormals[ J ] := M.AxisY;
                              Normals  [ J ] := M.AxisZ;
                              TexCoord0[ J ] := TPointF.Create( T.X, T.Y );

                              Inc( J );
                         end;
                    end;
               end;
          end;

          with IndexBuffer do
          begin
               Length := PatcsN{Patc} * Pow2( _DivN ){Quad} * 2{Tria} * 3{Poin};

               I0 := 0;
               J  := 0;
               for I := 1 to PatcsN do
               begin
                    for Y0 := 0 to _DivN-1 do
                    begin
                         Y1 := Y0 + 1;

                         for X0 := 0 to _DivN-1 do
                         begin
                              X1 := X0 + 1;

                              //    X0      X1
                              //  Y0┼───┼
                              //    │＼    │
                              //    │  ＼  │
                              //    │    ＼│
                              //  Y1┼───┼

                              Indices[ J ] := XYtoI( X0, Y0 );  Inc( J );
                              Indices[ J ] := XYtoI( X1, Y0 );  Inc( J );
                              Indices[ J ] := XYtoI( X1, Y1 );  Inc( J );

                              Indices[ J ] := XYtoI( X1, Y1 );  Inc( J );
                              Indices[ J ] := XYtoI( X0, Y1 );  Inc( J );
                              Indices[ J ] := XYtoI( X0, Y0 );  Inc( J );
                         end;
                    end;

                    Inc( I0, N2 );
               end;
          end;
     end;

     Repaint;
end;

//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& protected

/////////////////////////////////////////////////////////////////////// アクセス

procedure TTeapotShape.SetDivN( const DivN_:Integer );
begin
     _DivN := DivN_;  MakeModel;
end;

/////////////////////////////////////////////////////////////////////// メソッド

procedure TTeapotShape.Render;
begin
     Context.SetMatrix( AbsoluteMatrix);

     _Geometry.Render( Context, TMaterialSource.ValidMaterial(_Material), AbsoluteOpacity );
end;

//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& public

constructor TTeapotShape.Create( Owner_:TComponent );
begin
     inherited;

     _Geometry := TMeshData.Create;

     HitTest := False;

     _DivN := 1;

     MakeModel;
end;

destructor TTeapotShape.Destroy;
begin
     _Geometry.Free;

     inherited;
end;

//$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$【ルーチン】

//############################################################################## □

initialization //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ 初期化

finalization //$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ 最終化

end. //######################################################################### ■
